Notes for Developers
--------------------

## Collaboration

To open discussion of collaboration possibilities, please email <abhyaasa108@gmail.com>.

This project uses [semantic versioning](http://semver.org).


## Repository setup and test

The following assumes an OSX development platform.

Install [xcode](https://developer.apple.com/xcode/download/): needed for emulator and USB-connected device testing. See http://www.macinstruct.com/node/494.

Clone the app repository, creating an `app` directory in the current directory:
```
$ git clone https://github.com/abhyaasa/app
$ cd app
```
Unless noted otherwise, throughout the development process all subsequent CLI commands are to be executed in the project directory.

The following command line completes a minimal app development installation. If global dependencies are already installed, use the `local_setup.sh` script instead. The voluminous output generated by the script may overflow the terminal buffer, so output is saved in `temp/setup.txt` for inspection if something goes wrong.  It concludes by running the app in the default browser.
```
$ ./scripts/full_setup.sh | tee temp/setup.txt
```

Install [Chrome Canary](https://www.google.com/chrome/browser/canary.html) for server app testing in the preferred development browser, as with `$ gulp si -i`.

Test the app in the iOS emulator with `$ g ei`.

An Apple developer membership is required for testing on a usb-connected device, as with `g ri`. 

Install [Atom](https://atom.io), or other development editor, as needed.

This completes a minimal development environment setup. The following section lists the development tools required or recommended for this project, some of which require further installation.


## Tools

Development tools

- `git`: version control
- `ionic`: top-level app framework and CLI command
- `AngularJS`: base app framework
- `angular-ui-router`: improved state management
- `underscore`: Javascript utility library
- `cordova`: cross-platform app framework
- `gulp`: development task manager
- `node`: development Javascript interpreter
- `python`: preferred language for stand-alone development scripts
- `bower`: app package manager
- `karma`: test runner
- `protractor`: integration task manager
- `chrome`: development test browser (`Chrome Canary` preferred)
- `css` and `scss`: HTML style manager, and syntactically-superior development-time variant
- `markdown`: preprocessor for simplified html markup
- `npm`: development package manager
- `nvm`: node and nvm version manager (very helpful in some environments)
- `xcode`: iOS app deployment and setup for device testing (only on OSX)
- `genymotion`: Android app emulation

Recommended development environment

- `OSX`: required for iOS development
- `brew`: Ruby-based OSX package manager
- `atom`: preferred for most text editing
- `GitHub Desktop`: makes routine git operations convenient (`SourceTree` might be preferable)
- `iTerm`: better OSX upterminal emulator
- `inkscape`: svg to png conversion and other vector graphic editing


## Tasks

This app is early in development, with plenty to do. See

- `todo.md` file
- tags listed in `.todo` througout source files
- GitHub [Issues](https://github.com/abhyaasa/app/issues) list


### Atom editor

`.atom_config.cson` has recommended `~/.atom/config.cson` contents.

Atom plugins are indicated by the following list
```
$ /bin/ls ~/.atom/packages
README.md		docblockr		linter-htmlhint
atom-beautify		editor-settings		linter-jscs
atom-html-preview	emmet			linter-pylint
atom-material-syntax	file-icons		linter-scss-lint
atom-material-ui	file-types		linter-xmllint
atomic-emacs		highlight-line		local-history
autocomplete-python	jshint			merge-conflicts
autoprefixer		jsonlint		pretty-json
color-picker		linter			select-rectangle
csscomb			linter-coffeelint	todo-show
csslint			linter-coffeescript	xml-formatter
```

`config.cson` links to `~/.atom/config.cson` for version control.

The atom config files, including those of the plugins, indicates preferred coding and formatting styles.

### Ionic view

[Ionic view](http://view.ionic.io) supports allows convenient iOS and Android testing and sharing of development versions an iOS or Android app. Each developer used their own account.

### gulp

Use the gulp CLI command only in the project directory.

Run `gulp help` for an annotated list of gulp project management tasks.

`gulp index` generates `./www/index.html` from `./index.html`, so edit only the latter. This avoids superfluous version control changes, as script injection order is unpredictable.

The `g` script runs shortcuts in the gulp `cmdAliases` configuration variable. For example, to initiate the most common debugging run, execute `g si`. This runs `gulp cmd si | tee temp/cmd.txt`, which runs `gulp si -i`, which runs the default gulp test build tasks and then `ionic serve -c -t ios --browser /Applications/Google\ Chrome\ Canary.app`, with output appearing on the console and saved in `temp/cmd.txt`. Run `gulp cmd` for alias list.

Use `g help` for a list of the `gulp cmd` aliases.


## Config

The `www/data/config.json` file object has the keys `name`, `email`, `href`, `version`, and `flavor`. The last should only be changed by `gulp flavor`.

Early in app initialization, the config object is stored stored as `$rootScope.config`.


## Debugging and building

The `mode` constant in `services.js` may be set to `'debug'`, `'build'`, or `'normal'`.

In debug mode:

- the `$log.debug` is enabled
- the library tab is always enabled to permit the browser debug console to be enabled (cmd-opt-I in chrome)

In build mode:

- the angular compiler is told not to include debug information, such as dom state links


## Flavors and data directory structure

You test and build with the current **flavor** of your choice. Change the flavor with `gulp flavor --name NAME`, which must be run after system download. The distribution comes with support for the `test` flavor, but that may not be the current flavor of distribution branches.

For each `FLAVOR` there is a `data/flavors/FLAVOR` directory with `library`, `media`, and `resources` subdirectories. If the flavor uses cdecks, there is also a `data/cdecks/FLAVOR` directory . If a deck contains media file references, those files are in a subdirectory of the `media` directory named after the deck.

`library` directories contain `DECK_NAME.json` files, where `DECK_NAME` is the name of the deck with underscores in place of spaces, and an `index.json` file containing a list of the deck file names.

`./resources` link points to `data/flavors/<current flavor>/resources/` to keep the `ionic resources` command happy so it can transform splash and icon image files.


## Scripts

Python and shell scripts. All but `g` are in the `scripts` directory.

### Shell scripts

- `g ALIAS` is a shortcut for invoking via `gulp cmd` the script associated with `ALIAS` in the `cmdAliases` dictionary defined early in `gulpfile.js`.
- `full_setup.sh` installs global and local dependencies.
- `local_setup.sh` installs local dependencies.
- `term.sh` is used by `gulp itest`.
- `scapp.sh` used by gulp `sc` alias for testing clone of the app.
- `testapp.sh` used by gulp `ta` alias for testing build from standard template.
- `upload.sh` uploads the app for testing with the **ionic view** app.
- `psclean.sh` removes stray processes that may be created by ionic development. If the message "An uncaught exception occurred and has been reported to Ionic" is seen, try running this script and confirm with the `ps` output that there are no stray processes. Kill them manually if need be.

### Python scripts

- `cdeck.py --format_help` provides documentation on deck and compact deck file formats.
- `index.py` creates `index.json` files for data `library` directories.
- `trans.py` converts between Devanagari and several transliteration scripts.

Correct `.py` script initial `#!` script lines as needed if `/usr/bin/env python` does not run Python 2.6+ (maybe earlier). Python 3.x will not work.

Use `-h` argument for script usage information.

### jsdoc documentation

`gulp dengi` generates jsdoc documentation in the `doc/build/` directory.

REVIEW flesh out this documentation


## `$rootScope` variables

- `config`: configuration represented by `www/data/config.json`, with the following possible additional attributes:
  - `hideLibrary`: true if just one library element
- `hideTabs`: false until tabs bar configured after library index loaded
- `debug`: true when `mode` is `'debug'`
- `help`: points to help controller of current context


## `localStorage` key map

`*settings*`: `settings` service dictionary
`*openDecks*`: array of open deck display names
OPEN_DECK_DISPLAY_NAME: decks's data dictionary


## Updating

### resources

After a change has been made to an image file at top level in the `resources` directory of the current flavor, the following to update the `android` and `ios` subdirectories.
```
$ ionic resources
```

### Update ruby gems used by gulp (and ionic?)

```
$ brew update
```
If this fails:
```
$ cd `brew --prefix`
# can skip next if remote origin already exists
$ git remote add origin https://github.com/mxcl/homebrew.git
$ git fetch origin
$ git reset --hard origin/master
$ brew update
```

### Update local and global development libraries.

Make sure that `package.json` is consistent with the installed local dependencies.
```
$ ionic state save
```

Update global dependencies.
```
$ npm update -g cordova ionic ios-sim
```

A major ionic update should be followed by updating (in this case by rebuilding) all local dependencies in `node_modules/`, `plugins/`, `platforms/`, and `www.lib`.
```
$ ionic state reset
```
Unmet dependency warnings can probably be ignored. If problems, try
`sudo npm uninstall -g ionic && sudo npm install ionic`, and repeat above.

### Tool updates

Node [update instructions]( http://theholmesoffice.com/node-js-fundamentals-how-to-upgrade-the-node-js-version/).

Atom update: Preferences (Settings, cmd-,) > Updates > Update All
